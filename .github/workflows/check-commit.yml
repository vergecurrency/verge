name: CI

on:
  push:
  pull_request:

jobs:
  macos-26:
    runs-on: macos-26

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode_26.0.1.app

      - name: Install dependencies
        run: |
          brew install automake autoconf pkg-config libtool \
            berkeley-db@4 zeromq miniupnpc \
            qt@5 gperf qrencode librsvg

      - name: Link brew deps
        run: brew link qt@5 berkeley-db@4

      - name: Create local tap
        run: brew tap-new vergecurrency/local

      - name: Install protobuf 2.6.1
        run: |
          FORMULA="depends/homebrew-formulas/protobuf261.rb"
          TAP_DIR="$(brew --repo vergecurrency/local)/Formula"
          mkdir -p "$TAP_DIR"
          cp "$FORMULA" "$TAP_DIR/"
          brew install vergecurrency/local/protobuf261

      - name: Install boost 1.76
        run: |
          FORMULA="depends/homebrew-formulas/boost176.rb"
          TAP_DIR="$(brew --repo vergecurrency/local)/Formula"
          mkdir -p "$TAP_DIR"
          cp "$FORMULA" "$TAP_DIR/"
          brew install vergecurrency/local/boost176

      - name: Resolve build environment
        run: |
          BOOST="$(brew --cellar)/boost176/$(ls $(brew --cellar)/boost176 | sort -V | tail -n1)"
          PROTO="$(brew --cellar)/protobuf261/$(ls $(brew --cellar)/protobuf261 | sort -V | tail -n1)"

          echo "BOOST_ROOT=$BOOST" >> $GITHUB_ENV
          echo "BOOST_INCLUDEDIR=$BOOST/include" >> $GITHUB_ENV
          echo "BOOST_LIBRARYDIR=$BOOST/lib" >> $GITHUB_ENV

          echo "PROTOBUF_ROOT=$PROTO" >> $GITHUB_ENV
          echo "PROTOBUF_INCLUDEDIR=$PROTO/include" >> $GITHUB_ENV
          echo "PROTOBUF_LIBRARYDIR=$PROTO/lib" >> $GITHUB_ENV

          echo "CPPFLAGS=-I$BOOST/include -I$PROTO/include" >> $GITHUB_ENV
          echo "LDFLAGS=-L$BOOST/lib -L$PROTO/lib" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$PROTO/lib/pkgconfig:${PKG_CONFIG_PATH:-}" >> $GITHUB_ENV
          echo "PATH=$PROTO/bin:$(brew --prefix)/bin:$(brew --prefix)/sbin:${PATH:-/usr/bin:/bin}" >> $GITHUB_ENV

      - name: Autogen
        run: ./autogen.sh

      - name: Configure
        run: |
          export CXXFLAGS="-Wno-deprecated-builtins -Wno-deprecated-declarations"
          export CFLAGS="-Wno-deprecated-builtins -Wno-deprecated-declarations"
          ./configure \
            --disable-tests \
            --disable-bench \
            --disable-werror \
            --with-gui \
            --with-boost="$BOOST_ROOT" \
            --with-boost-libdir="$BOOST_LIBRARYDIR" \
            --bindir="$(pwd)/release/bin" \
            --libdir="$(pwd)/release/lib" \
            --with-openssl-dir=/opt/homebrew/Cellar/openssl@3/3.6.1 \
            --with-libevent-dir=/opt/homebrew/Cellar/libevent/2.1.12_1

      - name: Build
        run: make -j4
        
      - name: Test verged daemon
        run: |
            VERGED_BIN="./src/verged"
            CLI_BIN="./src/verge-cli"

            if [ ! -f "$VERGED_BIN" ]; then
            echo "::error::verged not found at $VERGED_BIN"
            exit 1
            fi

            # Run daemon in background
            "$VERGED_BIN" -daemon

            # Give it a few seconds to start
            sleep 5

            # Verify it's running
            if ! pgrep -f verged >/dev/null; then
            echo "::error::verged failed to start"
            exit 1
            fi

            # Query info with CLI
            "$CLI_BIN" getinfo || true

            # Stop the daemon
            "$CLI_BIN" stop

      - name: Wrap binary into .app bundle
        run: |
            # Locate the verge-qt binary
            BINARY=$(find . -name "verge-qt" -type f | head -n1)
            if [ -z "$BINARY" ] || [ ! -f "$BINARY" ]; then
            echo "::error::verge-qt binary not found after make"
            exit 1
            fi
            echo "Found verge-qt at $BINARY"
            
            # Create .app bundle
            APP_NAME="Verge.app"
            mkdir -p "$APP_NAME/Contents/MacOS"
            cp "$BINARY" "$APP_NAME/Contents/MacOS/"
            
            # Minimal Info.plist
            echo '<?xml version="1.0" encoding="UTF-8"?>' > "$APP_NAME/Contents/Info.plist"
            echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> "$APP_NAME/Contents/Info.plist"
            echo '<plist version="1.0">' >> "$APP_NAME/Contents/Info.plist"
            echo '<dict>' >> "$APP_NAME/Contents/Info.plist"
            echo '  <key>CFBundleName</key>' >> "$APP_NAME/Contents/Info.plist"
            echo '  <string>Verge</string>' >> "$APP_NAME/Contents/Info.plist"
            echo '  <key>CFBundleIdentifier</key>' >> "$APP_NAME/Contents/Info.plist"
            echo '  <string>org.vergefoundation.verge-qt</string>' >> "$APP_NAME/Contents/Info.plist"
            echo '  <key>CFBundleVersion</key>' >> "$APP_NAME/Contents/Info.plist"
            echo '  <string>1.0</string>' >> "$APP_NAME/Contents/Info.plist"
            echo '  <key>CFBundleExecutable</key>' >> "$APP_NAME/Contents/Info.plist"
            echo '  <string>verge-qt</string>' >> "$APP_NAME/Contents/Info.plist"
            echo '  <key>CFBundlePackageType</key>' >> "$APP_NAME/Contents/Info.plist"
            echo '  <string>APPL</string>' >> "$APP_NAME/Contents/Info.plist"
            echo '</dict>' >> "$APP_NAME/Contents/Info.plist"
            echo '</plist>' >> "$APP_NAME/Contents/Info.plist"

      - name: Bundle with macdeployqt
        run: |
          APP_NAME="Verge.app"
          macdeployqt "$APP_NAME" -verbose=2

      - name: Fix dylib install names
        run: |
          APP="Verge.app"
          find "$APP" -type f -perm +111 | while read f; do
            otool -L "$f" | grep /opt/homebrew | awk '{print $1}' | while read dep; do
              base=$(basename "$dep")
              new="@executable_path/../Frameworks/$base"
              install_name_tool -change "$dep" "$new" "$f" || true
            done
          done

      - name: Remove quarantine
        run: find . -name "*.app" -type d -exec xattr -cr {} +

      - name: Codesign app
        run: codesign --force --deep --options runtime --sign - "Verge.app"

      - name: Create DMG
        run: hdiutil create Verge.dmg -srcfolder "Verge.app" -ov -format UDZO

      - name: Gatekeeper check
        run: spctl --assess --type execute --verbose Verge.dmg || true

      - uses: actions/upload-artifact@v4
        with:
          name: verge-macos26
          path: Verge.dmg


  macos14:
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: git config credential.helper
        run: git config credential.helper
        
      - name: Create local tap for protobuf
        run: |
          brew tap-new verge/local
          mkdir -p $(brew --repo verge/local)/Formula
          curl -L https://raw.githubusercontent.com/vergecurrency/protobuf261/master/protobuf261.rb \
          -o $(brew --repo verge/local)/Formula/protobuf261.rb
          brew install verge/local/protobuf261
          
      - name: Install boost176 via temporary tap
        run: |
          brew tap-new verge/local || true
          mkdir -p $(brew --repo verge/local)/Formula
          curl -L https://raw.githubusercontent.com/vergecurrency/verge/refs/heads/master/depends/homebrew-formulas/boost176.rb \
          -o $(brew --repo verge/local)/Formula/boost176.rb
          brew install verge/local/boost176

      - name: Brew install base dependencies
        run: |
          # A workaround for "The `brew link` step did not complete successfully" error.
          brew install --quiet python@3 || brew link --overwrite python@3
          brew install --quiet automake autoconf berkeley-db@4 pkg-config miniupnpc zeromq libtool qt@5 gperf qrencode librsvg
        
      - name: Brew link dependencies
        run: brew link boost176 qt@5 berkeley-db@4
        
      - name: check cellar for openssl 
        run: cd /opt/homebrew/Cellar/openssl@3/ && ls
        
      - name: which clang/xcode
        run: clang --version

      - name: Auto generate
        run: ./autogen.sh

      - name: configure
        run: export LDFLAGS="-L/opt/homebrew/opt/boost176/lib" && export CPPFLAGS="-I/opt/homebrew/opt/boost176/include" && ./configure --disable-bench --disable-tests --disable-dependency-tracking --disable-werror --with-gui --bindir=`pwd`/release/bin --libdir=`pwd`/release/lib --with-openssl-dir=/opt/homebrew/Cellar/openssl@3/3.6.1 --with-libevent-dir=/opt/homebrew/Cellar/libevent/2.1.12_1 --with-boost=/opt/homebrew/Cellar/boost176/1.76.0_6

      - name: make
        run: make -j4
        
      - name: make .dmg
        run: make deploy
        
      - name: Sign app bundle
        run: |
          APP=$(find . -name "*.app" -type d | head -n 1)
          codesign --force --deep --sign - "$APP"

      - uses: actions/upload-artifact@v4
        with:
          name: verge-macos14
          path: |
            *.dmg

  ubuntu24:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Cache depends artifacts
        uses: actions/cache@v4
        with:
          path: |
            depends/built
            depends/x86_64-linux-gnu
            depends/work
            depends/sources
          key: depends-${{ runner.os }}-linux64-${{ hashFiles('depends/packages/**', 'depends/hosts/**', 'depends/**.mk', 'depends/Makefile') }}
          restore-keys: |
            depends-${{ runner.os }}-linux64-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-linux64-${{ hashFiles('configure.ac', 'Makefile.am', 'src/**', 'build-aux/**') }}
          restore-keys: |
            ccache-${{ runner.os }}-linux64-

      - name: Update apt repos
        run: sudo apt-get update

      - name: Install base dependencies
        run: |
          sudo apt-get install -y \
          build-essential xutils-dev libtool gperf autotools-dev automake pkg-config \
          bsdmainutils libattr1-dev make automake bison byacc cmake curl \
          g++-multilib binutils-gold python3 ccache

      - name: Enable ccache wrappers
        run: |
          sudo /usr/sbin/update-ccache-symlinks || true
          echo "/usr/lib/ccache" >> "$GITHUB_PATH"

      - name: Configure ccache
        env:
          CCACHE_DIR: ~/.ccache
        run: |
          mkdir -p ~/.ccache
          echo 'max_size = 2G' > ~/.ccache/ccache.conf
          echo 'compression = true' >> ~/.ccache/ccache.conf
          ccache -z || true

      - name: Export toolchain env
        run: |
          echo "CC=gcc"        >> "$GITHUB_ENV"
          echo "CXX=g++"       >> "$GITHUB_ENV"
          echo "AR=ar"         >> "$GITHUB_ENV"
          echo "RANLIB=ranlib" >> "$GITHUB_ENV"
          echo "STRIP=strip"   >> "$GITHUB_ENV"
          echo "CCACHE_DIR=$HOME/.ccache" >> "$GITHUB_ENV"

      - name: Build depends
        run: |
          cd depends/
          make -j4 HOST=x86_64-linux-gnu

      - name: Auto generate
        run: ./autogen.sh

      - name: configure
        run: |
          CONFIG_SITE=$PWD/depends/x86_64-linux-gnu/share/config.site \
          ./configure --enable-scrypt-sse2 --disable-bench --disable-tests \
          --disable-dependency-tracking --disable-werror \
          --prefix="$(pwd)/depends/x86_64-linux-gnu" \
          --bindir="$(pwd)/release/bin" \
          --libdir="$(pwd)/release/lib"

      - name: make
        run: make -j4

      - name: strip
        run: |
          cd ./src && strip verged verge-cli verge-tx
          cd ./qt && strip verge-qt

      - name: ccache stats
        env:
          CCACHE_DIR: ~/.ccache
        run: ccache -s || true

      - uses: actions/upload-artifact@v4
        with:
          name: verge-ubuntu24
          path: |
            ./src/verged
            ./src/verge-cli
            ./src/verge-tx
            ./src/qt/verge-qt

  ubuntu22:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Cache depends artifacts
        uses: actions/cache@v4
        with:
          path: |
            depends/built
            depends/x86_64-linux-gnu
            depends/work
            depends/sources
          key: depends-${{ runner.os }}-linux64-22-${{ hashFiles('depends/packages/**', 'depends/hosts/**', 'depends/**.mk', 'depends/Makefile') }}
          restore-keys: |
            depends-${{ runner.os }}-linux64-22-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-linux64-22-${{ hashFiles('configure.ac', 'Makefile.am', 'src/**', 'build-aux/**') }}
          restore-keys: |
            ccache-${{ runner.os }}-linux64-22-

      - name: Update apt repos
        run: sudo apt-get update

      - name: Install base dependencies
        run: |
          sudo apt-get install -y \
          build-essential xutils-dev libtool gperf autotools-dev automake pkg-config \
          bsdmainutils libattr1-dev make automake bison byacc cmake curl \
          g++-multilib binutils-gold python3 ccache

      - name: Enable ccache wrappers
        run: |
          sudo /usr/sbin/update-ccache-symlinks || true
          echo "/usr/lib/ccache" >> "$GITHUB_PATH"

      - name: Configure ccache
        env:
          CCACHE_DIR: ~/.ccache
        run: |
          mkdir -p ~/.ccache
          echo 'max_size = 2G' > ~/.ccache/ccache.conf
          echo 'compression = true' >> ~/.ccache/ccache.conf
          ccache -z || true

      - name: Build depends
        run: |
          cd depends/
          make -j4 HOST=x86_64-linux-gnu

      - name: Auto generate
        run: ./autogen.sh

      - name: configure
        run: |
          CONFIG_SITE=$PWD/depends/x86_64-linux-gnu/share/config.site \
          ./configure --enable-scrypt-sse2 --disable-bench --disable-tests \
          --disable-dependency-tracking --disable-werror \
          --prefix="$(pwd)/depends/x86_64-linux-gnu" \
          --bindir="$(pwd)/release/bin" \
          --libdir="$(pwd)/release/lib"

      - name: make
        run: make -j4

      - name: strip
        run: |
          cd ./src && strip verged verge-cli verge-tx
          cd ./qt && strip verge-qt

      - name: ccache stats
        env:
          CCACHE_DIR: ~/.ccache
        run: ccache -s || true

      - uses: actions/upload-artifact@v4
        with:
          name: verge-ubuntu22
          path: |
            ./src/verged
            ./src/verge-cli
            ./src/verge-tx
            ./src/qt/verge-qt
            
  raspberrypi:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Update apt repos
        run: sudo apt-get update

      - name: Install base dependencies
        run: |
          sudo apt-get install -y \
          libseccomp-dev git build-essential xutils-dev libtool gperf autotools-dev \
          automake pkg-config bsdmainutils libattr1-dev make automake bison byacc \
          cmake curl bison byacc python3 libcap-dev gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Export toolchain env
        run: |
          echo "CC=gcc"        >> "$GITHUB_ENV"
          echo "CXX=g++"       >> "$GITHUB_ENV"
          echo "AR=ar"         >> "$GITHUB_ENV"
          echo "RANLIB=ranlib" >> "$GITHUB_ENV"
          echo "STRIP=strip"   >> "$GITHUB_ENV"

      - name: Build depends
        run: |
          cd depends/
          make -j4 HOST=aarch64-linux-gnu

      - name: Auto generate
        run: ./autogen.sh

      - name: configure
        run: |
          CONFIG_SITE=$PWD/depends/aarch64-linux-gnu/share/config.site ./configure --build=aarch64-linux-gnu -disable-bench \
          --disable-tests --disable-dependency-tracking --disable-werror --bindir=`pwd`/release/bin \
          --prefix="$(pwd)/depends/aarch64-linux-gnu" \
          --bindir="$(pwd)/release/bin" \
          --libdir="$(pwd)/release/lib"

      - name: make
        run: make -j4

      - name: strip
        run: |
          cd ./src && strip verged verge-cli verge-tx
          cd ./qt && strip verge-qt

      - uses: actions/upload-artifact@v4
        with:
          name: verge-aarch64-pi5
          path: |
            ./src/verged
            ./src/verge-cli
            ./src/verge-tx
            ./src/qt/verge-qt

  windows32-ubuntu22:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Cache depends artifacts
        uses: actions/cache@v4
        with:
          path: |
            depends/built
            depends/i686-w64-mingw32
            depends/work
            depends/sources
          key: depends-${{ runner.os }}-mingw32-32-v7-${{ hashFiles('depends/packages/**', 'depends/hosts/**', 'depends/**.mk', 'depends/Makefile') }}
          restore-keys: |
            depends-${{ runner.os }}-mingw32-32-v7-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-mingw32-32-v7-${{ hashFiles('configure.ac', 'Makefile.am', 'src/**', 'build-aux/**') }}
          restore-keys: |
            ccache-${{ runner.os }}-mingw32-32-v7-

      - name: Update apt repos
        run: sudo apt-get update

      - name: Install base dependencies
        run: |
          sudo apt-get install -y \
          build-essential libtool gperf autotools-dev automake pkg-config \
          bsdmainutils curl git bison byacc python3 nsis ccache \
          g++-mingw-w64-i686 mingw-w64-i686-dev

      - name: Force Posix
        run: sudo update-alternatives --set i686-w64-mingw32-g++ /usr/bin/i686-w64-mingw32-g++-posix

      - name: Build depends for MingW32 Cross Compile
        run: |
          unset STRIP || true
          cd depends/
          timeout 45m make HOST=i686-w64-mingw32 -j2 STRIP=strip V=1 --output-sync=recurse

      - name: Auto generate
        run: ./autogen.sh

      - name: Export toolchain env (target)
        run: |
          echo "CC=i686-w64-mingw32-gcc-posix"          >> "$GITHUB_ENV"
          echo "CXX=i686-w64-mingw32-g++-posix"         >> "$GITHUB_ENV"
          echo "AR=i686-w64-mingw32-ar"                 >> "$GITHUB_ENV"
          echo "RANLIB=i686-w64-mingw32-ranlib"         >> "$GITHUB_ENV"
          echo "WINDRES=i686-w64-mingw32-windres"       >> "$GITHUB_ENV"
          echo "PKG_CONFIG=i686-w64-mingw32-pkg-config" >> "$GITHUB_ENV"
          echo "CCACHE_BASEDIR=$GITHUB_WORKSPACE"       >> "$GITHUB_ENV"
          echo "CCACHE_DIR=$HOME/.ccache"               >> "$GITHUB_ENV"
          echo "ARFLAGS=rcs"                            >> "$GITHUB_ENV"

      - name: Configure ccache
        env:
          CCACHE_DIR: ~/.ccache
        run: |
          mkdir -p ~/.ccache
          echo 'max_size = 2G' > ~/.ccache/ccache.conf
          echo 'compression = true' >> ~/.ccache/ccache.conf
          ccache -z || true

      - name: configure
        run: |
          CONFIG_SITE=$PWD/depends/i686-w64-mingw32/share/config.site \
          ./configure --prefix=/ --disable-bench --disable-tests

      - name: make (serialized, verbose, heartbeat)
        env:
          STRIP: ""
          V: "1"
        run: |
          set -e
          ( while true; do
              echo "---- heartbeat $(date) ----"
              ps -ef | egrep 'mingw|windres|ar|ranlib|ld|gcc|g\+\+|libtool' | grep -v egrep || true
              sleep 60
            done ) &
          HB=$!
          timeout 60m make -j1 --output-sync=recurse
          kill "$HB" || true

      - name: strip (cross)
        run: |
          cd ./src && i686-w64-mingw32-strip verged.exe verge-cli.exe verge-tx.exe
          cd ./qt && i686-w64-mingw32-strip verge-qt.exe

      - name: ccache stats
        env:
          CCACHE_DIR: ~/.ccache
        run: ccache -s || true

      - uses: actions/upload-artifact@v4
        with:
          name: verge-windows32-ubuntu22
          path: |
            /home/runner/work/verge/verge/src/verged.exe
            /home/runner/work/verge/verge/src/verge-cli.exe
            /home/runner/work/verge/verge/src/verge-tx.exe
            /home/runner/work/verge/verge/src/qt/verge-qt.exe

  windows64-ubuntu22:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Cache depends artifacts
        uses: actions/cache@v4
        with:
          path: |
            depends/built
            depends/x86_64-w64-mingw32
            depends/work
            depends/sources
          key: depends-${{ runner.os }}-mingw64-64-v7-${{ hashFiles('depends/packages/**', 'depends/hosts/**', 'depends/**.mk', 'depends/Makefile') }}
          restore-keys: |
            depends-${{ runner.os }}-mingw64-64-v7-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-mingw64-64-v7-${{ hashFiles('configure.ac', 'Makefile.am', 'src/**', 'build-aux/**') }}
          restore-keys: |
            ccache-${{ runner.os }}-mingw64-64-v7-

      - name: Update apt repos
        run: sudo apt-get update

      - name: Install base dependencies
        run: |
          sudo apt-get install -y \
          build-essential libtool gperf autotools-dev automake pkg-config \
          bsdmainutils curl git bison byacc python3 nsis ccache \
          g++-mingw-w64-x86-64

      - name: Force Posix
        run: sudo update-alternatives --set x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix

      - name: Build depends for MingW64 Cross Compile
        run: |
          unset STRIP || true
          cd depends/
          timeout 45m make HOST=x86_64-w64-mingw32 -j2 STRIP=strip V=1 --output-sync=recurse

      - name: Auto generate
        run: ./autogen.sh

      - name: Export toolchain env
        run: |
          echo "CC=x86_64-w64-mingw32-gcc-posix"          >> "$GITHUB_ENV"
          echo "CXX=x86_64-w64-mingw32-g++-posix"         >> "$GITHUB_ENV"
          echo "AR=x86_64-w64-mingw32-ar"                 >> "$GITHUB_ENV"
          echo "RANLIB=x86_64-w64-mingw32-ranlib"         >> "$GITHUB_ENV"
          echo "WINDRES=x86_64-w64-mingw32-windres"       >> "$GITHUB_ENV"
          echo "PKG_CONFIG=x86_64-w64-mingw32-pkg-config" >> "$GITHUB_ENV"
          echo "CCACHE_BASEDIR=$GITHUB_WORKSPACE"         >> "$GITHUB_ENV"
          echo "CCACHE_DIR=$HOME/.ccache"                 >> "$GITHUB_ENV"
          echo "ARFLAGS=rcs"                               >> "$GITHUB_ENV"

      - name: Configure ccache
        env:
          CCACHE_DIR: ~/.ccache
        run: |
          mkdir -p ~/.ccache
          echo 'max_size = 2G' > ~/.ccache/ccache.conf
          echo 'compression = true' >> ~/.ccache/ccache.conf
          ccache -z || true

      - name: configure
        run: |
          CONFIG_SITE=$PWD/depends/x86_64-w64-mingw32/share/config.site \
          ./configure --enable-scrypt-sse2 --prefix=/ --disable-bench --disable-tests

      - name: make (serialized, verbose, heartbeat)
        env:
          STRIP: ""
          V: "1"
        run: |
          set -e
          ( while true; do
              echo "---- heartbeat $(date) ----"
              ps -ef | egrep 'mingw|windres|ar|ranlib|ld|gcc|g\+\+|libtool' | grep -v egrep || true
              sleep 60
            done ) &
          HB=$!
          timeout 60m make -j1 --output-sync=recurse
          kill "$HB" || true

      - name: strip (cross)
        run: |
          cd ./src && x86_64-w64-mingw32-strip verged.exe verge-cli.exe verge-tx.exe
          cd ./qt && x86_64-w64-mingw32-strip verge-qt.exe

      - name: ccache stats
        env:
          CCACHE_DIR: ~/.ccache
        run: ccache -s || true

      - name: Dump config.log on failure
        if: failure()
        run: test -f config.log && sed -n '1,200p' config.log || true

      - uses: actions/upload-artifact@v4
        with:
          name: verge-windows64bit-ubuntu22
          path: |
            /home/runner/work/verge/verge/src/verged.exe
            /home/runner/work/verge/verge/src/verge-cli.exe
            /home/runner/work/verge/verge/src/verge-tx.exe
            /home/runner/work/verge/verge/src/qt/verge-qt.exe
