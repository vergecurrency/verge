jobs:
  linux:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - name: Install ARM64 toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu

      - name: Install base dependencies
        run: |
          sudo apt-get install -y \
            build-essential xutils-dev libtool gperf \
            autotools-dev automake pkg-config bsdmainutils \
            libattr1-dev bison byacc cmake curl python3

      - name: Build depends
        run: |
          export CC=aarch64-linux-gnu-gcc
          export CXX=aarch64-linux-gnu-g++
          export AR=aarch64-linux-gnu-ar
          export RANLIB=aarch64-linux-gnu-ranlib
          make -C depends -j$(nproc) HOST=aarch64-linux-gnu

      - name: Autogen
        run: ./autogen.sh

      - name: Configure
        run: |
          export CC=aarch64-linux-gnu-gcc
          export CXX=aarch64-linux-gnu-g++
          CONFIG_SITE=$PWD/depends/aarch64-linux-gnu/share/config.site \
          ./configure \
            --build=x86_64-pc-linux-gnu \
            --host=aarch64-linux-gnu \
            --disable-bench \
            --disable-tests \
            --disable-dependency-tracking \
            --disable-werror \
            --prefix=$PWD/depends/aarch64-linux-gnu

      - name: Build
        run: make -j$(nproc)
